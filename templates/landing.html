{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% block content %}
<style>
    .hero-banner {
        background: linear-gradient(45deg, #004d00, #006400);
        color: white;
        padding: 80px 0;
        border-radius: 0 0 50px 50px;
        margin-top: -24px;
        margin-bottom: 50px;
    }
    .video-card {
        background: #000;
        border-radius: 20px;
        overflow: hidden;
        position: relative;
        transition: transform 0.3s ease;
        height: 450px;
        border: 4px solid transparent;
    }
    .video-card:hover {
        transform: scale(1.02);
        border-color: #ffd700;
    }
    .play-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 3rem;
        color: rgba(255,255,255,0.7);
        pointer-events: none;
    }
    .pillar-card {
        border: none;
        border-bottom: 5px solid #006400;
        transition: 0.3s;
    }
    .pillar-card:hover {
        background: #f0fff0;
        transform: translateY(-10px);
    }
    .ticker-container {
        background: #fff;
        display: flex;
        overflow: hidden;
        border-radius: 50px;
        border: 1px solid #eee;
    }
    .ticker-label {
        background: #d9534f; /* Red for urgency */
        color: white;
        padding: 10px 20px;
        font-weight: bold;
        white-space: nowrap;
        z-index: 2;
    }
    .ticker-wrap {
        flex-grow: 1;
        overflow: hidden;
        display: flex;
        align-items: center;
    }
    .ticker-move {
        white-space: nowrap;
        display: inline-block;
        animation: ticker-animation 30s linear infinite;
        padding-left: 100%;
    }
    .ticker-item {
        display: inline-block;
        padding: 0 20px;
        font-weight: 500;
        color: #006400;
    }
    @keyframes ticker-animation {
        0% { transform: translate3d(0, 0, 0); }
        100% { transform: translate3d(-100%, 0, 0); }
    }
    /* 1. Make the container stay at the BOTTOM of the screen */
    .sticky-ticker-container {
        position: fixed;
        bottom: 0; /* Change to 'top: 0' if you prefer it at the very top */
        left: 0;
        width: 100%;
        z-index: 1050; /* Ensures it stays above all other content */
        border-top: 2px solid #dc3545; /* Adds a nice red accent line */
    }

    /* 2. The Sliding Animation */
    .landing-ticker-move {
        display: inline-block;
        white-space: nowrap;
        padding-left: 100%;
        animation: landingMarquee 40s linear infinite; /* 40s is smoother for long text */
    }

    /* Pause on hover so people can actually read the news */
    .landing-ticker-move:hover {
        animation-play-state: paused;
        cursor: pointer;
    }

    @keyframes landingMarquee {
        0% { transform: translateX(0); }
        100% { transform: translateX(-100%); }
    }

    /* 3. Mobile Adjustments */
    @media (max-width: 768px) {
        .sticky-ticker-container {
            height: 40px; /* Slightly slimmer on mobile */
        }
        .landing-ticker-move {
            animation-duration: 25s; /* Moves slightly faster on small screens to keep interest */
            font-size: 0.85rem;
        }
    }
</style>
<div class="sticky-ticker-container shadow-lg">
    <div class="d-flex align-items-center bg-dark overflow-hidden" style="height: 45px;">
        <div class="bg-danger text-white px-3 py-2 fw-bold small text-uppercase h-100 d-flex align-items-center" style="z-index: 10; position: relative; box-shadow: 5px 0 15px rgba(0,0,0,0.3);">
            {% trans "Updates" %}
        </div>

        <div class="flex-grow-1 position-relative overflow-hidden">
            <div class="landing-ticker-move text-white">
                {% for a in announcements %}
                    <span class="mx-4 fw-medium"><i class="bi bi-megaphone-fill me-2 text-warning"></i>{{ a.content }}</span>
                {% empty %}
                    <span class="mx-4">{% trans "Welcome to our official portal. Stay tuned for live updates." %}</span>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<div id="mainGallery" class="carousel slide carousel-fade mb-5 shadow" data-bs-ride="carousel">
    <div class="carousel-inner" style="border-radius: 15px; height: 400px;">
        {% for item in gallery %}
        <div class="carousel-item {% if forloop.first %}active{% endif %}" data-bs-interval="3000">
            <img src="{{ item.image.url }}" class="d-block w-100" style="object-fit: cover; height: 400px;" alt="{{ item.title }}">
            {% if item.title %}
            <div class="carousel-caption d-none d-md-block" style="background: rgba(0,0,0,0.5); border-radius: 10px;">
                <h5>{{ item.title }}</h5>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <div class="carousel-item active">
            <img src="https://via.placeholder.com/1200x400?text=JIBWIS+Nigeria+Activity+Images" class="d-block w-100" style="object-fit: cover; height: 400px;">
        </div>
        {% endfor %}
    </div>
    <button class="carousel-control-prev" type="button" data-bs-target="#mainGallery" data-bs-slide="prev">
        <span class="carousel-control-prev-icon"></span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#mainGallery" data-bs-slide="next">
        <span class="carousel-control-next-icon"></span>
    </button>
</div>


<div class="hero-banner text-center shadow">
    <div class="container">
        <div class="logo-box mx-auto mb-4" style="width: 150px; height: 150px; background: white; border-radius: 70%; display: flex; align-items: center; justify-content: center; ">
                <img src="{% static 'images/izala_logo.png' %}" style="width: 100%;">
        </div>
        <h1 class="display-4 fw-bold">{% trans "JIBWIS Digital Portal" %}</h1>
        <p class="lead">{% trans "Unifying the Sunnah across Nigeria: Admin ‚Ä¢ Ulama ‚Ä¢ FAG" %}</p>
        <div class="mt-4">
            <a href="{% url 'register' %}" class="btn btn-gold btn-lg px-5 shadow">{% trans "Join Now" %}</a>
        </div>
    </div>
</div>

    <div class="row g-4 text-center">
        <div class="col-md-4">
            <div class="card pillar-card shadow-sm p-4">
                <h1 class="mb-3">üèõÔ∏è</h1>
                <h4>{% trans "Administration" %}</h4>
                <p class="small text-muted">{% trans "National to Ward level leadership coordination." %}</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card pillar-card shadow-sm p-4">
                <h1 class="mb-3">üìñ</h1>
                <h4>{% trans "Council of Ulama" %}</h4>
                <p class="small text-muted">{% trans "Management of scholars and educational backgrounds." %}</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card pillar-card shadow-sm p-4">
                <h1 class="mb-3">üöë</h1>
                <h4>{% trans "First Aid Group" %}</h4>
                <p class="small text-muted">{% trans "Divisional, Detachment, and Unit leadership." %}</p>
            </div>
        </div>
    </div>
</div>
<div class="container my-5">
    <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
        <div class="row g-0">
            <div class="col-md-4 bg-success text-white p-5 d-flex flex-column justify-content-center">
                <h3 class="fw-bold mb-3">{% trans "Visit Us" %}</h3>
                <p><i class="bi bi-geo-alt-fill"></i> {% trans "JIBWIS National Headquarters," %}<br>{% trans "Kaduna, Kaduna State, Nigeria." %}</p>
                <p><i class="bi bi-telephone-fill"></i> +234 800 JIBWIS HQ</p>
                <p><i class="bi bi-envelope-fill"></i> info@jibwiskdnigeria.org</p>
            </div>
            <div class="embed-map-fixed"><div class="embed-map-container"><iframe class="embed-map-frame" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?width=600&height=400&hl=en&q=JIBWIS%20HQ%20ABUJA&t=h&z=9&ie=UTF8&iwloc=B&output=embed"></iframe><a href="https://funclicker.org" style="font-size:2px!important;color:gray!important;position:absolute;bottom:0;left:0;z-index:1;max-height:1px;overflow:hidden">Fun Clicker</a></div><style>.embed-map-fixed{position:relative;text-align:right;width:600px;height:400px;}.embed-map-container{overflow:hidden;background:none!important;width:600px;height:400px;}.embed-map-frame{width:600px!important;height:400px!important;}</style>
            </div>
        </div>
    </div>
</div>
<div class="container my-5">
    <div class="row">
        <div class="col-md-8">
            <h3 class="border-bottom border-success pb-2 text-success">{% trans "Latest Announcements" %}</h3>
            {% for update in news %}
            <div class="card mb-3 border-0 shadow-sm">
                <div class="row g-0">
                    <div class="col-md-4">
                        <img src="{{ update.image.url }}" class="img-fluid rounded-start" alt="...">
                    </div>
                    <div class="col-md-8">
                        <div class="card-body">
                            <h5 class="card-title fw-bold">{{ update.title }}</h5>
                            <p class="card-text text-muted small">{{ update.created_at|date:"M d, Y" }}</p>
                            <p class="card-text">{{ update.content|truncatewords:20 }}</p>
                            <a href="#" class="btn btn-sm btn-success">{% trans "Read More" %}</a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <section class="py-5 bg-light">
            <div class="container">
                <h2 class="text-center fw-bold text-success mb-5">{% trans "JIBWIS Media Updates" %}</h2>
                <div class="row g-4">
                    {% for video in videos %}
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-0 shadow-sm rounded-4 overflow-hidden h-100">
                            <div class="ratio ratio-16x9">
                                <video controls
                                    {% if video.thumbnail %} poster="{{ video.thumbnail.url }}" {% endif %}
                                    class="rounded-top">
                                    <source src="{{ video.video_file.url }}" type="video/mp4">
                                </video>
                            </div>

                            <div class="card-body">
                                <h6 class="fw-bold mb-3">{{ video.title }}</h6>

                                <div class="d-flex justify-content-between align-items-center border-top pt-3">
                                    <div class="d-flex gap-4">
                                        <button class="btn btn-link text-decoration-none p-0 text-dark" onclick="toggleLike('{{ video.id }}')">
                                            <i id="v-icon-{{ video.id }}"
                                               class="bi bi-heart{% if video.id in request.session.guest_liked_videos or user in video.likes.all %}-fill text-danger{% endif %} fs-5"></i>
                                            <small id="v-count-{{ video.id }}" class="d-block text-center">{{ video.total_likes }}</small>
                                        </button>

                                        <button class="btn btn-link text-decoration-none p-0 text-dark"
                                                onclick="shareOnWhatsApp('{{ video.title|escapejs }}', '{{ request.build_absolute_uri }}')">
                                            <i class="bi bi-whatsapp fs-5 text-success"></i>
                                            <small class="d-block text-center text-muted">{% trans "Share" %}</small>
                                        </button>
                                    </div>

                                    <a href="{{ video.video_file.url }}" download class="btn btn-success btn-sm rounded-pill px-3">
                                        <i class="bi bi-download me-1"></i> {% trans "Download" %}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>
    </div>
</div>
<div class="d-flex gap-3 align-items-center">
    <div class="text-muted small">
        <i class="bi bi-eye me-1"></i> {{ video.views_count }}
    </div>

    <button class="btn btn-link text-decoration-none p-0 text-dark like-btn" data-id="{{ video.id }}">
        <i class="bi bi-heart{% if user in video.likes.all %}-fill text-danger{% endif %}"></i>
        <small>{{ video.total_likes }}</small>
    </button>
</div>

<script>
    // Logic to count views when video starts playing
    document.querySelectorAll('video').forEach(videoElement => {
        videoElement.addEventListener('play', function() {
            const videoId = this.closest('.card').querySelector('.like-btn').dataset.id;

            fetch(`/video/view/${videoId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            });
        }, { once: true }); // Only count one view per page load
    });

    // REAL-TIME LIKE TOGGLE
    function toggleLike(videoId) {
        // 1. Get CSRF Token from cookies (standard Django way)
        const getCookie = (name) => {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        };

        fetch(`/video/like/${videoId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            // If user isn't logged in, redirect to login page
            if (response.status === 403 || response.redirected) {
                window.location.href = '/login/';
                return;
            }
            return response.json();
        })
        .then(data => {
            if (data) {
                const icon = document.getElementById(`v-icon-${videoId}`);
                const count = document.getElementById(`v-count-${videoId}`);

                count.innerText = data.count;
                if (data.liked) {
                    icon.classList.replace('bi-heart', 'bi-heart-fill');
                    icon.classList.add('text-danger');
                } else {
                    icon.classList.replace('bi-heart-fill', 'bi-heart');
                    icon.classList.remove('text-danger');
                }
            }
        })
        .catch(err => console.error('Error:', err));
    }
    // REAL WHATSAPP SHARE
    function shareOnWhatsApp(title) {
        // This gets the real URL of the page you are currently on
        const currentUrl = window.location.href;
        const text = `*JIBWIS Media Update*\n\n*${title}*\n\nWatch here: ${currentUrl}`;

        // Encodes the text so it works in a URL
        const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`;

        // Opens WhatsApp in a new tab
        window.open(whatsappUrl, '_blank');
    }
</script>
{% endblock %}